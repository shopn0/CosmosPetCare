<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pets - Cosmos Pet Care</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../css/main.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-paw me-2"></i>Cosmos Pet Care
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="pets.html">My Pets</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="appointments.html">Appointments</a>
                    </li>
                </ul>
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-1"></i> <span class="user-name">User</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="profile.html">Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item logout-btn" href="#">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <div class="mb-3">
                                <i class="fas fa-user-circle" style="font-size: 5rem; color: var(--primary-color);"></i>
                            </div>
                            <h5 class="user-name">User Name</h5>
                            <p class="text-muted mb-0">Pet Owner</p>
                        </div>
                        <hr>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="dashboard.html">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" href="pets.html">
                                    <i class="fas fa-paw"></i> My Pets
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="appointments.html">
                                    <i class="fas fa-calendar-check"></i> Appointments
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="payments.html">
                                    <i class="fas fa-credit-card"></i> Payments
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="profile.html">
                                    <i class="fas fa-user-cog"></i> Profile
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link logout-btn" href="#">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="alert-container"></div>
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">My Pets</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPetModal">
                        <i class="fas fa-plus-circle me-1"></i> Add New Pet
                    </button>
                </div>
                
                <div class="row" id="pets-container">
                    <div class="col-12 text-center py-5">
                        <div class="loading-spinner"></div>
                        <p class="mt-3">Loading pets...</p>
                    </div>
                </div>
                
                <!-- Pet Details View -->
                <div id="pet-details-container" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <button class="btn btn-outline-primary btn-sm" id="back-to-pets">
                            <i class="fas fa-arrow-left me-1"></i> Back to Pets
                        </button>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" id="edit-pet-btn">
                                <i class="fas fa-edit me-1"></i> Edit
                            </button>
                            <button class="btn btn-outline-danger btn-sm" id="delete-pet-btn">
                                <i class="fas fa-trash-alt me-1"></i> Delete
                            </button>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 text-center mb-4 mb-md-0">
                                    <img id="pet-image" src="https://placehold.co/300x300?text=Pet" alt="Pet" class="img-fluid rounded-circle mb-3" style="width: 200px; height: 200px; object-fit: cover;">
                                    <h4 id="pet-name" class="mb-1">Pet Name</h4>
                                    <p id="pet-breed" class="text-muted">Breed</p>
                                </div>
                                <div class="col-md-8">
                                    <div class="row mb-3">
                                        <div class="col-sm-4">
                                            <p class="mb-0 text-muted">Type</p>
                                        </div>
                                        <div class="col-sm-8">
                                            <p id="pet-type" class="mb-0 fw-bold">Dog</p>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-sm-4">
                                            <p class="mb-0 text-muted">Age</p>
                                        </div>
                                        <div class="col-sm-8">
                                            <p id="pet-age" class="mb-0 fw-bold">3 years</p>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-sm-4">
                                            <p class="mb-0 text-muted">Gender</p>
                                        </div>
                                        <div class="col-sm-8">
                                            <p id="pet-gender" class="mb-0 fw-bold">Male</p>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-sm-4">
                                            <p class="mb-0 text-muted">Color</p>
                                        </div>
                                        <div class="col-sm-8">
                                            <p id="pet-color" class="mb-0 fw-bold">Brown</p>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-sm-4">
                                            <p class="mb-0 text-muted">Added On</p>
                                        </div>
                                        <div class="col-sm-8">
                                            <p id="pet-created" class="mb-0">01 Jan 2023</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-white">
                            <a href="appointments.html?book=true&pet=" class="btn btn-primary" id="book-appointment-btn">
                                <i class="fas fa-calendar-plus me-1"></i> Book Appointment
                            </a>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Appointments</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Vet</th>
                                            <th>Status</th>
                                            <th>Diagnosis</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pet-appointments">
                                        <tr>
                                            <td colspan="5" class="text-center py-3">No appointments found.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Pet Modal -->
    <div class="modal fade" id="addPetModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Pet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-pet-form">
                        <div class="mb-3">
                            <label for="pet-name-input" class="form-label">Pet Name</label>
                            <input type="text" class="form-control" id="pet-name-input" required>
                        </div>
                        <div class="mb-3">
                            <label for="pet-type-input" class="form-label">Type</label>
                            <select class="form-select" id="pet-type-input" required>
                                <option value="">Select type</option>
                                <option value="Dog">Dog</option>
                                <option value="Cat">Cat</option>
                                <option value="Bird">Bird</option>
                                <option value="Fish">Fish</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="pet-breed-input" class="form-label">Breed</label>
                            <input type="text" class="form-control" id="pet-breed-input" required>
                        </div>
                        <div class="mb-3">
                            <label for="pet-age-input" class="form-label">Age (years)</label>
                            <input type="number" class="form-control" id="pet-age-input" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="pet-gender-input" class="form-label">Gender</label>
                            <select class="form-select" id="pet-gender-input" required>
                                <option value="">Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="unknown">Unknown</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="pet-color-input" class="form-label">Color</label>
                            <input type="text" class="form-control" id="pet-color-input" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-pet-btn">Save Pet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Pet Modal -->
    <div class="modal fade" id="editPetModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Pet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-pet-form">
                        <input type="hidden" id="edit-pet-id">
                        <div class="mb-3">
                            <label for="edit-pet-name" class="form-label">Pet Name</label>
                            <input type="text" class="form-control" id="edit-pet-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-pet-type" class="form-label">Type</label>
                            <select class="form-select" id="edit-pet-type" required>
                                <option value="">Select type</option>
                                <option value="Dog">Dog</option>
                                <option value="Cat">Cat</option>
                                <option value="Bird">Bird</option>
                                <option value="Fish">Fish</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-pet-breed" class="form-label">Breed</label>
                            <input type="text" class="form-control" id="edit-pet-breed" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-pet-age" class="form-label">Age (years)</label>
                            <input type="number" class="form-control" id="edit-pet-age" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-pet-gender" class="form-label">Gender</label>
                            <select class="form-select" id="edit-pet-gender" required>
                                <option value="">Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="unknown">Unknown</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-pet-color" class="form-label">Color</label>
                            <input type="text" class="form-control" id="edit-pet-color" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="update-pet-btn">Update Pet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Pet Confirmation Modal -->
    <div class="modal fade" id="deletePetModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this pet? This action cannot be undone.</p>
                    <p class="mb-0 fw-bold" id="delete-pet-name"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-pet-btn">Delete Pet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-4 border-top">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 Cosmos Pet Care</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Custom JS -->
    <script src="../js/main.js"></script>
    <script>
        let currentPetId = null;
        let petsData = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in and has customer role
            if (!AUTH.isLoggedIn() || AUTH.getRole() !== 'customer') {
                window.location.href = '../login.html';
                return;
            }
            
            // Check if pet ID is in URL
            const urlParams = new URLSearchParams(window.location.search);
            const petId = urlParams.get('id');
            
            if (petId) {
                // Show pet details view
                loadPetDetails(petId);
            } else {
                // Show all pets view
                loadPets();
            }
            
            // Event handlers
            document.querySelector('.logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                AUTH.clearAuth();
                window.location.href = '../login.html';
            });
            
            // Back button handler
            document.getElementById('back-to-pets').addEventListener('click', function() {
                document.getElementById('pet-details-container').classList.add('d-none');
                document.getElementById('pets-container').classList.remove('d-none');
                // Update URL without reloading page
                history.pushState({}, '', 'pets.html');
                currentPetId = null;
            });
            
            // Save new pet handler
            document.getElementById('save-pet-btn').addEventListener('click', addPet);
            
            // Edit pet button handler
            document.getElementById('edit-pet-btn').addEventListener('click', function() {
                // Find the current pet data
                const pet = petsData.find(p => p.id == currentPetId);
                if (!pet) return;
                
                // Populate edit form
                document.getElementById('edit-pet-id').value = pet.id;
                document.getElementById('edit-pet-name').value = pet.name;
                document.getElementById('edit-pet-type').value = pet.type;
                document.getElementById('edit-pet-breed').value = pet.breed;
                document.getElementById('edit-pet-age').value = pet.age;
                document.getElementById('edit-pet-gender').value = pet.gender;
                document.getElementById('edit-pet-color').value = pet.color;
                
                // Show modal
                new bootstrap.Modal(document.getElementById('editPetModal')).show();
            });
            
            // Update pet handler
            document.getElementById('update-pet-btn').addEventListener('click', updatePet);
            
            // Delete pet button handler
            document.getElementById('delete-pet-btn').addEventListener('click', function() {
                // Find the current pet data
                const pet = petsData.find(p => p.id == currentPetId);
                if (!pet) return;
                
                // Set pet name in confirmation modal
                document.getElementById('delete-pet-name').textContent = pet.name;
                
                // Show modal
                new bootstrap.Modal(document.getElementById('deletePetModal')).show();
            });
            
            // Confirm delete handler
            document.getElementById('confirm-delete-pet-btn').addEventListener('click', deletePet);
        });
        
        async function loadPets() {
            try {
                const response = await fetch(`${API_BASE_URL}/pets_get.php?owner_id=${AUTH.user.id}`, {
                    headers: {
                        'Authorization': `Bearer ${AUTH.token}`
                    }
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    petsData = result.data.pets;
                    displayPets(petsData);
                } else {
                    document.getElementById('pets-container').innerHTML = 
                        `<div class="col-12 text-center py-5">
                            <i class="fas fa-paw fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">No pets found</h5>
                            <p class="mb-4">You haven't added any pets yet.</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPetModal">
                                <i class="fas fa-plus-circle me-1"></i> Add New Pet
                            </button>
                        </div>`;
                }
            } catch (error) {
                console.error('Error loading pets:', error);
                UTILS.showAlert('Error loading pets. Please try again.', 'danger');
            }
        }
        
        function displayPets(pets) {
            if (!pets || pets.length === 0) {
                document.getElementById('pets-container').innerHTML = 
                    `<div class="col-12 text-center py-5">
                        <i class="fas fa-paw fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No pets found</h5>
                        <p class="mb-4">You haven't added any pets yet.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPetModal">
                            <i class="fas fa-plus-circle me-1"></i> Add New Pet
                        </button>
                    </div>`;
                return;
            }
            
            let petsHtml = '';
            
            pets.forEach(pet => {
                const petImage = pet.type.toLowerCase() === 'dog' ? 'dog.jpg' : 
                               pet.type.toLowerCase() === 'cat' ? 'cat.jpg' : 
                               pet.type.toLowerCase() === 'bird' ? 'bird.jpg' : 'pet.jpg';
                
                petsHtml += `
                <div class="col-md-4 col-sm-6 mb-4">
                    <div class="card pet-card h-100">
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <img src="https://placehold.co/200x200?text=${pet.type}" alt="${pet.name}" class="pet-image">
                            </div>
                            <h5 class="card-title text-center">${pet.name}</h5>
                            <p class="text-center text-muted mb-3">${pet.breed}</p>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="badge bg-primary">${pet.type}</span>
                                <span class="badge bg-secondary">${pet.age} years</span>
                                <span class="badge bg-info">${pet.gender}</span>
                            </div>
                        </div>
                        <div class="card-footer bg-white d-flex justify-content-between">
                            <a href="pets.html?id=${pet.id}" class="btn btn-sm btn-outline-primary">View Details</a>
                            <a href="appointments.html?book=true&pet=${pet.id}" class="btn btn-sm btn-primary">Book Appointment</a>
                        </div>
                    </div>
                </div>`;
            });
            
            document.getElementById('pets-container').innerHTML = petsHtml;
        }
        
        async function loadPetDetails(petId) {
            try {
                const response = await fetch(`${API_BASE_URL}/pets_get.php?id=${petId}`, {
                    headers: {
                        'Authorization': `Bearer ${AUTH.token}`
                    }
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    const pet = result.data.pet;
                    
                    // Save pet data to global array if not already there
                    if (!petsData.some(p => p.id == pet.id)) {
                        petsData.push(pet);
                    }
                    
                    // Update current pet ID
                    currentPetId = pet.id;
                    
                    // Update pet details in UI
                    document.getElementById('pet-name').textContent = pet.name;
                    document.getElementById('pet-breed').textContent = pet.breed;
                    document.getElementById('pet-type').textContent = pet.type;
                    document.getElementById('pet-age').textContent = `${pet.age} years`;
                    document.getElementById('pet-gender').textContent = pet.gender.charAt(0).toUpperCase() + pet.gender.slice(1);
                    document.getElementById('pet-color').textContent = pet.color;
                    document.getElementById('pet-created').textContent = new Date(pet.created_at).toLocaleDateString();
                    document.getElementById('pet-image').src = `https://placehold.co/300x300?text=${pet.type}`;
                    
                    // Update book appointment button link
                    document.getElementById('book-appointment-btn').href = `appointments.html?book=true&pet=${pet.id}`;
                    
                    // Load pet appointments
                    loadPetAppointments(pet.id);
                    
                    // Hide all pets view and show pet details view
                    document.getElementById('pets-container').classList.add('d-none');
                    document.getElementById('pet-details-container').classList.remove('d-none');
                } else {
                    UTILS.showAlert('Pet not found', 'danger');
                    loadPets(); // Show all pets instead
                }
            } catch (error) {
                console.error('Error loading pet details:', error);
                UTILS.showAlert('Error loading pet details. Please try again.', 'danger');
            }
        }
        
        async function loadPetAppointments(petId) {
            try {
                const response = await fetch(`${API_BASE_URL}/appointments_get.php?pet_id=${petId}`, {
                    headers: {
                        'Authorization': `Bearer ${AUTH.token}`
                    }
                });
                const result = await response.json();
                
                if (result.status === 'success' && result.data.appointments.length > 0) {
                    const appointments = result.data.appointments;
                    let appointmentsHtml = '';
                    
                    appointments.forEach(appointment => {
                        // Status badge
                        const statusClass = appointment.status === 'pending' ? 'badge-pending' :
                                          appointment.status === 'confirmed' ? 'badge-confirmed' :
                                          appointment.status === 'completed' ? 'badge-completed' :
                                          'badge-cancelled';
                        
                        // Format date
                        const appointmentDate = new Date(appointment.date);
                        const formattedDate = appointmentDate.toLocaleDateString() + ' ' + 
                                            appointmentDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        // Truncate diagnosis
                        const diagnosis = appointment.diagnosis ? 
                                        (appointment.diagnosis.length > 30 ? 
                                         appointment.diagnosis.substring(0, 30) + '...' : 
                                         appointment.diagnosis) : 
                                        'N/A';
                        
                        appointmentsHtml += `
                        <tr>
                            <td>${formattedDate}</td>
                            <td>Dr. ${appointment.vet_name}</td>
                            <td><span class="badge ${statusClass}">${appointment.status}</span></td>
                            <td>${diagnosis}</td>
                            <td>
                                <a href="appointments.html?id=${appointment.id}" class="btn btn-sm btn-outline-primary">View</a>
                            </td>
                        </tr>`;
                    });
                    
                    document.getElementById('pet-appointments').innerHTML = appointmentsHtml;
                } else {
                    document.getElementById('pet-appointments').innerHTML = 
                        `<tr>
                            <td colspan="5" class="text-center py-3">No appointments found for this pet.</td>
                        </tr>`;
                }
            } catch (error) {
                console.error('Error loading pet appointments:', error);
                document.getElementById('pet-appointments').innerHTML = 
                    `<tr>
                        <td colspan="5" class="text-center py-3">Error loading appointments. Please try again.</td>
                    </tr>`;
            }
        }
        
        async function addPet() {
            // Get form data
            const petData = {
                name: document.getElementById('pet-name-input').value,
                type: document.getElementById('pet-type-input').value,
                breed: document.getElementById('pet-breed-input').value,
                age: document.getElementById('pet-age-input').value,
                gender: document.getElementById('pet-gender-input').value,
                color: document.getElementById('pet-color-input').value
            };
            
            // Validate form
            if (!petData.name || !petData.type || !petData.breed || !petData.age || !petData.gender || !petData.color) {
                UTILS.showAlert('Please fill in all required fields', 'danger', '#addPetModal .modal-body');
                return;
            }
            
            try {
                // Show loading state
                const saveBtn = document.getElementById('save-pet-btn');
                const originalBtnText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';
                saveBtn.disabled = true;
                
                // Submit pet data
                const response = await API.pets.add(petData);
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addPetModal'));
                modal.hide();
                
                if (response.status === 'success') {
                    // Show success message
                    UTILS.showAlert('Pet added successfully!', 'success');
                    
                    // Reset form
                    document.getElementById('add-pet-form').reset();
                    
                    // Reload pets
                    loadPets();
                } else {
                    // Show error message
                    UTILS.showAlert(response.message || 'Failed to add pet', 'danger');
                }
                
                // Reset button
                saveBtn.innerHTML = originalBtnText;
                saveBtn.disabled = false;
            } catch (error) {
                console.error('Error adding pet:', error);
                UTILS.showAlert('Error adding pet. Please try again.', 'danger');
                
                // Reset button
                const saveBtn = document.getElementById('save-pet-btn');
                saveBtn.innerHTML = 'Save Pet';
                saveBtn.disabled = false;
            }
        }
        
        async function updatePet() {
            // Get form data
            const petId = document.getElementById('edit-pet-id').value;
            const petData = {
                id: petId,
                name: document.getElementById('edit-pet-name').value,
                type: document.getElementById('edit-pet-type').value,
                breed: document.getElementById('edit-pet-breed').value,
                age: document.getElementById('edit-pet-age').value,
                gender: document.getElementById('edit-pet-gender').value,
                color: document.getElementById('edit-pet-color').value
            };
            
            // Validate form
            if (!petData.name || !petData.type || !petData.breed || !petData.age || !petData.gender || !petData.color) {
                UTILS.showAlert('Please fill in all required fields', 'danger', '#editPetModal .modal-body');
                return;
            }
            
            try {
                // Show loading state
                const updateBtn = document.getElementById('update-pet-btn');
                const originalBtnText = updateBtn.innerHTML;
                updateBtn.innerHTML = '<span class="loading-spinner"></span> Updating...';
                updateBtn.disabled = true;
                
                // Submit pet data
                const response = await fetch(`${API_BASE_URL}/pets_update.php`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH.token}`
                    },
                    body: JSON.stringify(petData)
                });
                const result = await response.json();
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editPetModal'));
                modal.hide();
                
                if (result.status === 'success') {
                    // Show success message
                    UTILS.showAlert('Pet updated successfully!', 'success');
                    
                    // Reload pet details
                    loadPetDetails(petId);
                } else {
                    // Show error message
                    UTILS.showAlert(result.message || 'Failed to update pet', 'danger');
                }
                
                // Reset button
                updateBtn.innerHTML = originalBtnText;
                updateBtn.disabled = false;
            } catch (error) {
                console.error('Error updating pet:', error);
                UTILS.showAlert('Error updating pet. Please try again.', 'danger');
                
                // Reset button
                const updateBtn = document.getElementById('update-pet-btn');
                updateBtn.innerHTML = 'Update Pet';
                updateBtn.disabled = false;
            }
        }
        
        async function deletePet() {
            if (!currentPetId) return;
            
            try {
                // Show loading state
                const deleteBtn = document.getElementById('confirm-delete-pet-btn');
                const originalBtnText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<span class="loading-spinner"></span> Deleting...';
                deleteBtn.disabled = true;
                
                // Delete pet
                const response = await fetch(`${API_BASE_URL}/pets_delete.php?id=${currentPetId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AUTH.token}`
                    }
                });
                const result = await response.json();
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deletePetModal'));
                modal.hide();
                
                if (result.status === 'success') {
                    // Show success message
                    UTILS.showAlert('Pet deleted successfully!', 'success');
                    
                    // Redirect to pets list
                    window.location.href = 'pets.html';
                } else {
                    // Show error message
                    UTILS.showAlert(result.message || 'Failed to delete pet', 'danger');
                    
                    // Reset button
                    deleteBtn.innerHTML = originalBtnText;
                    deleteBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error deleting pet:', error);
                UTILS.showAlert('Error deleting pet. Please try again.', 'danger');
                
                // Reset button
                const deleteBtn = document.getElementById('confirm-delete-pet-btn');
                deleteBtn.innerHTML = 'Delete Pet';
                deleteBtn.disabled = false;
            }
        }
    </script>
</body>
</html>