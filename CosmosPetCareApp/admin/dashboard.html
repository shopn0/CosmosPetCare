<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Cosmos Pet Care</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <link href="../css/main.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-paw me-2"></i>Cosmos Pet Care
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">Users</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="payments.html">Payments</a>
                    </li>
                </ul>
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-shield me-1"></i> <span class="user-name">Admin</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="profile.html">Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item logout-btn" href="#">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <div class="mb-3">
                                <i class="fas fa-user-shield" style="font-size: 5rem; color: var(--primary-color);"></i>
                            </div>
                            <h5 class="user-name">Admin Name</h5>
                            <p class="text-muted mb-0">Administrator</p>
                        </div>
                        <hr>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="dashboard.html">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="users.html">
                                    <i class="fas fa-users"></i> Users
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="payments.html">
                                    <i class="fas fa-credit-card"></i> Payments
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="profile.html">
                                    <i class="fas fa-user-cog"></i> Profile
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link logout-btn" href="#">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="alert-container"></div>
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">Dashboard</h3>
                    <div>
                        <button id="refresh-dashboard-btn" class="btn btn-outline-primary">
                            <i class="fas fa-sync-alt me-1"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body d-flex align-items-center">
                                <div class="icon-box bg-primary text-white me-3">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">Total Users</h6>
                                    <h3 id="total-users" class="mb-0">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body d-flex align-items-center">
                                <div class="icon-box bg-success text-white me-3">
                                    <i class="fas fa-paw"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">Registered Pets</h6>
                                    <h3 id="total-pets" class="mb-0">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body d-flex align-items-center">
                                <div class="icon-box bg-info text-white me-3">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">Appointments</h6>
                                    <h3 id="total-appointments" class="mb-0">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body d-flex align-items-center">
                                <div class="icon-box bg-warning text-white me-3">
                                    <i class="fas fa-credit-card"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">Revenue</h6>
                                    <h3 id="total-revenue" class="mb-0">$0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="row mb-4">
                    <div class="col-md-8 mb-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Revenue Overview</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="revenue-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">User Distribution</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="users-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="row mb-4">
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Recent Appointments</h5>
                                <a href="#" class="text-decoration-none view-all-btn" data-type="appointments">View All</a>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush" id="recent-appointments">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div class="loading-spinner"></div>
                                        <span class="ms-3">Loading appointments...</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Recent Payments</h5>
                                <a href="payments.html" class="text-decoration-none">View All</a>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush" id="recent-payments">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div class="loading-spinner"></div>
                                        <span class="ms-3">Loading payments...</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="row">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">System Status</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <h6>Server Status</h6>
                                        <div class="d-flex align-items-center">
                                            <span class="status-indicator online me-2"></span>
                                            <span class="fw-bold">Online</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <h6>Database Status</h6>
                                        <div class="d-flex align-items-center">
                                            <span class="status-indicator online me-2"></span>
                                            <span class="fw-bold">Connected</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <h6>Last System Update</h6>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-calendar-alt me-2 text-muted"></i>
                                            <span id="last-update">April 29, 2025</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-4 border-top">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 Cosmos Pet Care</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Custom JS -->
    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in and has admin role
            if (!AUTH.isLoggedIn() || AUTH.getRole() !== 'admin') {
                window.location.href = '../login.html';
                return;
            }
            
            // Update user name in UI
            document.querySelectorAll('.user-name').forEach(el => {
                el.textContent = AUTH.user.name;
            });
            
            // Load dashboard data
            loadDashboardData();
            
            // Event handlers
            document.querySelector('.logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    AUTH.clearAuth();
                    window.location.href = '../login.html';
                }
            });
            
            // Refresh dashboard button
            document.getElementById('refresh-dashboard-btn').addEventListener('click', function() {
                loadDashboardData();
            });
            
            // View all appointments button
            document.querySelector('.view-all-btn[data-type="appointments"]').addEventListener('click', function(e) {
                e.preventDefault();
                // Redirect to a page that shows all appointments (could be created later)
                // For now, just show an alert
                UTILS.showAlert('Appointment management page coming soon!', 'info');
            });
            
            // Set current date as last update
            const currentDate = new Date();
            document.getElementById('last-update').textContent = currentDate.toLocaleDateString();
        });
        
        async function loadDashboardData() {
            try {
                // Show loading states
                document.getElementById('recent-appointments').innerHTML = `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="loading-spinner"></div>
                        <span class="ms-3">Loading appointments...</span>
                    </li>`;

                document.getElementById('recent-payments').innerHTML = `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="loading-spinner"></div>
                        <span class="ms-3">Loading payments...</span>
                    </li>`;

                // Load dashboard data from API
                const response = await fetch(`${API_BASE_URL}/admin_dashboard.php`, {
                    headers: {
                        'Authorization': `Bearer ${AUTH.token}`
                    }
                });

                const result = await response.json();

                if (result.status === 'success') {
                    const data = result.data;

                    // Update summary cards
                    document.getElementById('total-users').textContent = data.users.total || 0;
                    document.getElementById('total-pets').textContent = data.pets.total || 0;
                    document.getElementById('total-appointments').textContent = data.appointments.total || 0;

                    // Format revenue
                    const formattedRevenue = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        maximumFractionDigits: 0
                    }).format(data.revenue.total || 0);

                    document.getElementById('total-revenue').textContent = formattedRevenue;

                    // Recent appointments
                    if (data.appointments.recent && data.appointments.recent.length > 0) {
                        let appointmentsHtml = '';
                        data.appointments.recent.forEach(appointment => {
                            const appointmentDate = new Date(appointment.appointment_date);
                            const formattedDate = appointmentDate.toLocaleDateString();

                            // Status badge
                            let statusClass = '';
                            switch (appointment.status) {
                                case 'confirmed':
                                    statusClass = 'bg-success';
                                    break;
                                case 'pending':
                                    statusClass = 'bg-warning text-dark';
                                    break;
                                case 'cancelled':
                                    statusClass = 'bg-danger';
                                    break;
                                default:
                                    statusClass = 'bg-secondary';
                            }

                            appointmentsHtml += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${appointment.owner_name} - ${appointment.pet_name}</div>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i> ${formattedDate}
                                        <i class="fas fa-user-md ms-2 me-1"></i> ${appointment.vet_name || 'Any Vet'}
                                    </small>
                                </div>
                                <span class="badge ${statusClass}">${appointment.status}</span>
                            </li>`;
                        });

                        document.getElementById('recent-appointments').innerHTML = appointmentsHtml;
                    } else {
                        document.getElementById('recent-appointments').innerHTML = `
                            <li class="list-group-item text-center">No recent appointments found.</li>`;
                    }

                    // Recent payments
                    if (data.payments.recent && data.payments.recent.length > 0) {
                        let paymentsHtml = '';
                        data.payments.recent.forEach(payment => {
                            const paymentDate = new Date(payment.payment_date);
                            const formattedDate = paymentDate.toLocaleDateString();

                            // Format amount
                            const formattedAmount = new Intl.NumberFormat('en-US', {
                                style: 'currency',
                                currency: 'USD'
                            }).format(payment.amount);

                            // Status badge
                            const statusClass = payment.status === 'completed' ? 'bg-success' : 'bg-warning text-dark';

                            paymentsHtml += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${payment.owner_name}</div>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i> ${formattedDate}
                                        <i class="fas fa-credit-card ms-2 me-1"></i> ${payment.method}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <div>${formattedAmount}</div>
                                    <span class="badge ${statusClass}">${payment.status}</span>
                                </div>
                            </li>`;
                        });

                        document.getElementById('recent-payments').innerHTML = paymentsHtml;
                    } else {
                        document.getElementById('recent-payments').innerHTML = `
                            <li class="list-group-item text-center">No recent payments found.</li>`;
                    }

                    // Initialize charts
                    initRevenueChart(data.revenue.monthly || []);
                    initUsersChart(data.users);
                } else {
                    console.warn('Error loading dashboard data:', result.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        
        function initRevenueChart(monthlyData) {
            // If no chart data, use sample data
            if (!monthlyData || monthlyData.length === 0) {
                monthlyData = [
                    { month: 'Jan', revenue: 5000 },
                    { month: 'Feb', revenue: 7500 },
                    { month: 'Mar', revenue: 6000 },
                    { month: 'Apr', revenue: 9000 },
                    { month: 'May', revenue: 8500 },
                    { month: 'Jun', revenue: 10000 }
                ];
            }
            
            // Extract labels and data from monthly data
            const labels = monthlyData.map(item => item.month);
            const data = monthlyData.map(item => item.revenue);
            
            // Get the canvas element
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.revenueChart instanceof Chart) {
                window.revenueChart.destroy();
            }
            
            // Create new chart
            window.revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Revenue',
                        data: data,
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        pointBackgroundColor: '#4e73df',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#4e73df',
                        lineTension: 0.3,
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 25,
                            top: 25,
                            bottom: 0
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function initUsersChart(usersData) {
            // If no data, use sample data
            if (!usersData) {
                usersData = {
                    customers: 65,
                    vets: 15,
                    admins: 5
                };
            }
            
            // Set up data for pie chart
            const data = {
                labels: ['Customers', 'Veterinarians', 'Administrators'],
                datasets: [{
                    data: [
                        usersData.customers || 0,
                        usersData.vets || 0, 
                        usersData.admins || 0
                    ],
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc'],
                    hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf'],
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }]
            };
            
            // Get the canvas element
            const ctx = document.getElementById('users-chart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.usersChart instanceof Chart) {
                window.usersChart.destroy();
            }
            
            // Create new chart
            window.usersChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
    <script>
        // Test API Connection - This will help debug the dashboard data loading issues
        async function testAPIConnection() {
            console.log("Testing API connection...");
            
            try {
                // First test the debug endpoint without authentication
                const debugResponse = await fetch(`${API_BASE_URL}/debug.php`);
                const debugResult = await debugResponse.json();
                console.log("Debug API Test (no auth):", debugResult);
                
                // Then test the admin_dashboard.php endpoint with authentication
                console.log("Testing admin dashboard API with token:", AUTH.token);
                const dashboardResponse = await fetch(`${API_BASE_URL}/admin_dashboard.php`, {
                    headers: {
                        'Authorization': `Bearer ${AUTH.token}`
                    }
                });
                
                // Log the raw response
                console.log("Dashboard API Response status:", dashboardResponse.status);
                const dashboardText = await dashboardResponse.text();
                console.log("Dashboard API Raw response:", dashboardText);
                
                // Try to parse as JSON if possible
                try {
                    const dashboardResult = JSON.parse(dashboardText);
                    console.log("Dashboard API parsed JSON:", dashboardResult);
                } catch (e) {
                    console.error("Could not parse dashboard response as JSON:", e);
                }
            } catch (error) {
                console.error("API test failed:", error);
            }
        }
        
        // Run the test after the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add a small delay to allow other scripts to initialize
            setTimeout(testAPIConnection, 1000);
        });
    </script>
    <script>
        // Test API Connection - This will help debug the dashboard data loading issues
        document.addEventListener('DOMContentLoaded', function() {
            // Add API base URL if it's not defined in main.js
            if (typeof API_BASE_URL === 'undefined') {
                window.API_BASE_URL = '../php/api';
                console.log("API_BASE_URL set to:", API_BASE_URL);
            }
            
            // Define AUTH namespace if not already defined in main.js
            if (typeof AUTH === 'undefined') {
                window.AUTH = {
                    token: localStorage.getItem('token'),
                    user: JSON.parse(localStorage.getItem('user') || '{}'),
                    isLoggedIn: function() {
                        return !!this.token;
                    },
                    getRole: function() {
                        return this.user?.role || '';
                    },
                    clearAuth: function() {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        this.token = null;
                        this.user = {};
                    }
                };
                console.log("AUTH object initialized");
            }
            
            // Define UTILS namespace if not already defined in main.js
            if (typeof UTILS === 'undefined') {
                window.UTILS = {
                    showAlert: function(message, type = 'info') {
                        const alertContainer = document.querySelector('.alert-container');
                        if (!alertContainer) return;
                        
                        const alertId = 'alert-' + Date.now();
                        const alertHTML = `
                            <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                                ${message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;
                        
                        alertContainer.innerHTML = alertHTML + alertContainer.innerHTML;
                        
                        // Auto-dismiss after 5 seconds
                        setTimeout(() => {
                            const alert = document.getElementById(alertId);
                            if (alert) {
                                const bsAlert = new bootstrap.Alert(alert);
                                bsAlert.close();
                            }
                        }, 5000);
                    }
                };
                console.log("UTILS object initialized");
            }
        });
    </script>
</body>
</html>